<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="memoé€å—ä¿¡Style.css" />
  <title>memoãƒ»ãƒ¦ãƒ¼ã‚¶IDé€£æº</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

  <!-- FireBaseé–¢é€£ -->

  <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-firestore.js"></script>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBgmke1S6n1nKQZ0Ez6kJ85o3PEOklyKbI",
      authDomain: "qualification-master.firebaseapp.com",
      databaseURL: "https://qualification-master.firebaseio.com",
      projectId: "qualification-master",
      storageBucket: "qualification-master.appspot.com",
      messagingSenderId: "733843168310",
      appId: "1:733843168310:web:1aa23bde7d4373dd"
    });

    var db = firebase.firestore();

    var create_fusen;
  </script>

  <!-- å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³-->
  <script>

    var user;

    function login() {
      var email = "mathgamer.net@gmail.com";
      var password = "123456";
      firebase.auth().signInWithEmailAndPassword(email, password).then(function () {
        location.reload()
      }).catch(function (error) {
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log(errorCode);
        var errorMessage = ERROR_MESSAGE[errorCode] || ERROR_MESSAGE["auth/other"]
        document.getElementById("error-message").innerHTML = errorMessage;
      });
    }

    function logout() {
      firebase.auth().signOut().then(function () {
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚")
        location.reload()
      }).catch(function (error) {
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
      });
    }

    firebase.auth().onAuthStateChanged(function (_user) {
      if (_user) {
        user = _user
      } else {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼")
      }
    });

  </script>
  <!-- ãƒ¡ãƒ¢ã®æ›¸ãè¾¼ã¿å‡¦ç† -->

  <script>
    window.onload = function () {
      document.body.addEventListener("click", function (e) {
        document.getElementById("contextmenu").style.display = "none";
      });
    };

    function customMenu(e) {
      const selectedText = start()
      if (selectedText) {
        document.getElementById("contextmenu").style.left = e.pageX + "px";
        document.getElementById("contextmenu").style.top = e.pageY + "px";
        document.getElementById("contextmenu").style.display = "block";
        // å³ã‚¯ãƒªãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­¢ã‚ã‚‹
        e.preventDefault()
      }
    }

    function menu1() {
      if (user) {
        const selectedText = document.getSelection().toString();
        document.getElementById("selectedText").value = selectedText;
        document.getElementById("contextmenu").getClientRects()[0].left;
        console.log(document.getElementById("contextmenu").getClientRects());
        contextmenu = document.getElementById("contextmenu").getClientRects()[0];

        document.getElementById("memoarea").style.left = contextmenu.left + "px";
        document.getElementById("memoarea").style.top = contextmenu.top + "px";
        document.getElementById("memoarea").style.display = "block";
      } else {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ã¨ãƒ¡ãƒ¢ã¯æ›¸ãè¾¼ã‚ã¾ã›ã‚“");
      }
    }
    function menu2() {
      alert("æ–‡å­—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      const selectedText = document.getSelection().toString();
      document.getElementById("selectedText").value = selectedText;
      var copytext = document.execCommand("copy");
    }
    function menu3() {
      alert("é–“é•ã„å†…å®¹ã‚’æ•™ãˆã¦ä¸‹ã•ã„");
    }

    //ãƒ¡ãƒ¢ã‚’é€ã‚‹é–¢æ•°

    function send_memo() {
      //å†…å®¹ãŒç©ºã®æ™‚ã¯è­¦å‘Š

      if (document.getElementById("memocontents").value == "") {
        alert("ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      } else {
        // ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã™ã‚‹å‡¦ç†
        document.getElementById("memocontents").value;
        console.log(document.getElementById("memocontents").value);
        console.log(document.getElementById("selectedText").value);
        document.getElementById("memoarea").style.display = "none";

        //ã€€ãƒ¡ãƒ¢ã®é€ä¿¡

        var memo_send = {
          ã‚¤ã‚¤ãƒæ•°: 0, //åˆæœŸå€¤0
          ãƒ¡ãƒ¢å†…å®¹: document.getElementById("memocontents").value,
          ãƒ¦ãƒ¼ã‚¶ID: user.uid, //å–ã‚Šã‚ãˆãšå›ºå®š
          æ–‡ç« è©²å½“ä½ç½®: selectedObj["selectedText"],
          start: selectedObj["start"],
          end: selectedObj["end"]
        };

        //BBSç”¨ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡

        db.collection("databasetest")
          .add(memo_send)
          .then(function (docRef) {
            console.log("Document written with ID: ", docRef.id);
          })
          .catch(function (error) {
            console.error("Error adding document: ", error);
          });
      }

      // ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç†
      document.getElementById("memocontents").value = "";

      //ãƒªãƒ­ãƒ¼ãƒ‰

      setTimeout(function () {
        location.reload();
      }, 500);
    }

    //ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã™ã‚‹

    function deletememo(id) {

      db.collection("databasetest")
        .doc(id)
        .delete();

      //ãƒªãƒ­ãƒ¼ãƒ‰

      setTimeout(function () {
        location.reload();
      }, 500);
    }

    //ãƒ¡ãƒ¢ã‚’ç·¨é›†ã™ã‚‹

    function revision_memo(id) {

      db.collection("databasetest")
        .doc(id)
        .update({
          "ãƒ¡ãƒ¢å†…å®¹": document.getElementById(id).value
        })
      //ãƒªãƒ­ãƒ¼ãƒ‰

      setTimeout(function () {
        location.reload();
      }, 500);

    }

    //ã‚¤ã‚¤ãƒã‚’è¿½åŠ ã™ã‚‹

    function iineplus(id) {

      db.collection("databasetest")
        .doc(id)
        .update({
          "ã‚¤ã‚¤ãƒæ•°": firebase.firestore.FieldValue.increment(1)
        })
      //ãƒªãƒ­ãƒ¼ãƒ‰

      setTimeout(function () {
        location.reload();
      }, 500);
    }

    // ãƒ¡ãƒ¢ã‚’é–‰ã˜ã‚‹
    function close_memo() {
      document.getElementById("memoarea").style.display = "none";
      Array.from(document.getElementsByClassName("fusen")).forEach(function (fusen) {
        fusen.style.display = "none"
      })
    }
  </script>
</head>

<body onContextmenu="customMenu(event)">

  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <button onclick="start()">click</button>


  <main id="memo">

    <h2>è¿”å“ã¨ã¯</h2>

    <p>
      å–å¼•ãŒçµ‚ã‚ã‚Šç„¡äº‹ã«ãŠäº’ã„æº€è¶³ã—ã¦ãƒ»ãƒ»ãƒ»ãªã‚‰è‰¯ã„ã®ã§ã™ãŒã€ç‰©ã‚’æ‰±ã†ä»¥ä¸Šãã†ã™ã‚“ãªã‚Šçµ‚ã‚ã‚‹äº‹ã°ã‹ã‚Šã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ ä¸è‰¯å“ã‚„åº—å´ã®æ‰‹é•ã„ã§ãŠå®¢ã•ã‚“ãŒæº€è¶³ã›ãšã€å“ç‰©ãŒè¿”å“ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
      è¿”å“ã¯ä¸»ã«åº—å´ã®éå¤±ã«ã‚ˆã‚ŠãŠå®¢ã•ã‚“ã‹ã‚‰ç‰©ã‚’æˆ»ã•ã‚ŒãŸã¨ãã«è¡Œã†å‡¦ç†ã§ã™ã€‚
    </p>

  </main>

    <p>
      <span style="color:blue;">ä»Šæ—¥ã¯ã„ã„<span style="color:red;">å¤©æ°—</span>ã§ã™ã€‚</span>
    </p>

    <div id="contextmenu">
      <button onClick="menu1()" class="list-decoration">ãƒ¡ãƒ¢ã‚’æ›¸ãè¾¼ã‚€</button>
      <button onClick="menu2()" class="list-decoration">æ–‡å­—ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
      <button onClick="menu3()" class="list-decoration">é–“é•ã„ã‚’å ±å‘Šã™ã‚‹</button>
    </div>

    <div id="memoarea">
      <div class="cancel" onclick="close_memo()"></div>
      <p>
        <font color="red">ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</font>
      </p>
      <input type="hidden" id="selectedText" name="selectedText" value="" />

      <textarea id="memocontents" cols="30" rows="4"></textarea>
      <br><br><button onClick="send_memo()">ãƒ¡ãƒ¢ã‚’æ›¸ãè¾¼ã‚€</button>
    </div>
  <script>
    $(function () {
      //ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°

      // è¦ç´ ã¸ã®å‚ç…§ã‚’å–å¾—
      var textMsg = document.getElementsByTagName("main");

      var memo = new Array();
      let fusen = new Array();
      // windowã‚’ãƒªã‚µã‚¤ã‚ºã—ãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
      function resize(data) {
        console.log("resize")
        let memo_style = "";
        for (let i = 0; i < data.length; i++) {
          if (memo[i].getClientRects()[0].left > 400) {
            memo_style = `position: absolute; top: ${memo[i].getClientRects()[0].top + window.pageYOffset}px; left:${memo[i].getClientRects()[0].left - 200}px; display: ${fusen[i].style.display}`;
            fusen[i].setAttribute("style", memo_style);
          } else {
            memo_style = `position: absolute; top: ${memo[i].getClientRects()[0].top + window.pageYOffset}px; left:${memo[i].getClientRects()[0].left}px; display: ${fusen[i].style.display}`;
            fusen[i].setAttribute("style", memo_style);
          }
        }
      }

      //FireBaseã‹ã‚‰ã®èª­ã¿è¾¼ã¿

      const get_fusen = db.collection("databasetest");

      //åˆã‚ã›ã‚‹ã¨ãã¯1ã¤ã«
      var main = document.getElementsByTagName("main")[0];
      var i = 0;

      const memo_array = []

      get_fusen.get().then(function (querySnapshot) {
        querySnapshot.forEach(function (doc) {
          const memo_data = doc.data()
          memo_data.id = doc.id
          memo_array.push(memo_data)
        })

        m = memo_array.map(m => {
          return {
            start: m.start,
            end: m.end,
            "æ–‡ç« è©²å½“ä½ç½®": m.æ–‡ç« è©²å½“ä½ç½®
          }
        })
        //<span>ã‚¿ã‚°ã®æŒ¿å…¥
        let innerText = textMsg[0].innerText
        const arr = Array.from(innerText)
        const beforeData = memo_sort(memo_array)
        memo_sort(memo_array).forEach(function (data, j) {
          data = calcData(data, j, beforeData)
          arr.splice(data.start, 0, `<span id="${data.id}" class="memo">`);
          arr.splice(data.end, 0, '</span>');
        });
        // memo_sort(memo_array).forEach(function (data, j) {
        //   let replaceStart = innerHTML.slice(0, data.start)
        //   let replaceEnd = innerHTML.slice(data.start).replace(data.æ–‡ç« è©²å½“ä½ç½®, '<span class="memo' + j + ' under-line">' + data.æ–‡ç« è©²å½“ä½ç½® + "</span>")
        //   innerHTML = replaceStart + replaceEnd;
        // });
 
        textMsg[0].innerHTML = arr.join("");
        //ä»˜ç®‹ã®ä½œæˆ

        memo_sort(memo_array).forEach(function (data, k) {
          create_fusen = document.createElement("div");
          if (user && user.uid === data.ãƒ¦ãƒ¼ã‚¶ID) {
            create_fusen.innerHTML =
              `<div class="cancel" onclick="close_memo()"></div> ` +
              `<br><textarea id="${data.id}" cols="30" rows="4">${data.ãƒ¡ãƒ¢å†…å®¹}</textarea>` +
              `<br><br>ğŸ‘ï¼š` +
              data.ã‚¤ã‚¤ãƒæ•° +
              `</button><br><br><button onClick="deletememo('${data.id}')">ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã™ã‚‹</button>` +
              `<button onClick="revision_memo('${data.id}')">ãƒ¡ãƒ¢ã‚’ä¿®æ­£ã™ã‚‹</button>`;
          } else {
            create_fusen.innerHTML =
              `<div class="cancel" onclick="close_memo()"></div> ` +
              `<br>${data.ãƒ¡ãƒ¢å†…å®¹}` +
              `<br><br><button onClick="iineplus('${data.id}')">ğŸ‘ï¼š` +
              data.ã‚¤ã‚¤ãƒæ•°
          }
          create_fusen.classList.add("test" + data.id, "fusen");
          main.appendChild(create_fusen);

        });

        fusen_control(memo_array);
        // onresizeã‚¤ãƒ™ãƒ³ãƒˆã«resizeé–¢æ•°ã‚’è¨­å®šã™ã‚‹
        window.onresize = function () { resize(memo_array) }
      })

      function fusen_control(data) {
        for (let i = 0; i < data.length; i++) {
          // memo.push(document.querySelector(".memo" + i));
          memo.push(document.querySelector(`#memo span#${data[i].id}`));
          fusen.push(document.querySelector("div.test" + data[i].id));
        }

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã«ä»˜ç®‹ã®è¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹
        for (let i = 0; i < memo.length; i++) {
          memo[i].addEventListener("click", event => {
            event.preventDefault()
            $(fusen[i]).toggle();
          });
        }

        // ç”»é¢æç”»æ™‚ã«ä»˜ç®‹ã®ä½ç½®ã‚’è¨ˆç®—ã™ã‚‹
        resize(data);
      }
    });

    let selection;
    let selectedObj = {};
    const body = document.getElementById("memo").innerText
    document.addEventListener("selectionchange", () => {
      selection = window.getSelection();
    })

    function start() {
      let selectedText = String(selection)
      if (!selectedText) {
        return ""
      }
      selection.modify("extend", "forward", "line")
      let paragraph = String(selection)
      selection.modify("extend", "backward", "line")
      let start = body.indexOf(paragraph)
      selectedObj["start"] = start
      let end = start + selectedText.length
      selectedObj["end"] = end
      selectedObj["selectedText"] = selectedText
      console.log({ selectedText, start, end })
      return selectedText
    }

    function calcData(d, index, _data) {
      d = Object.assign({}, d)
      for(let i = 0; i < index; i++) {
        if (_data[i].start < _data[index].start) {
          d.start++
          d.end++
        }
        if (_data[i].end < _data[index].start) {
          d.start++
        }
        if (_data[i].end < _data[index].end) {
          d.end++
        }
      }
      d.end++
      return d
    }
 
    function memo_sort(_data) {
      let data = Object.assign([], _data) 
      //æœªæ•´åˆ—ã®éƒ¨åˆ†ã‹ã‚‰å€¤ã‚’ï¼‘ã¤ãšã¤å–ã‚Šå‡ºã™foræ–‡
      for (var i = 1; i < data.length; i++) {
        //ã€ŒæŒ¿å…¥ã™ã‚‹å€¤ã€ã‚’å¤‰æ•°ã«ä¸€æ™‚ä¿å­˜ã™ã‚‹
        let tmp = data[i];
    
        //ã€Œæ•´åˆ—æ¸ˆã¿ã®éƒ¨åˆ†ã€ã®ã©ã“ã«æŒ¿å…¥ã™ã‚Œã°è‰¯ã„ã‹å¾Œã‚ã‹ã‚‰å‰ã«å‘ã‹ã£ã¦é †ç•ªã«åˆ¤æ–­ã™ã‚‹
        for (var j = i - 1; j >= 0; j--) {
          //ã€ŒæŒ¿å…¥ã™ã‚‹å€¤ã€ãŒå¤§ãã„å ´åˆã€èª¿ã¹ãŸå€¤ã‚’ï¼‘ã¤å¾Œã‚ã¸ãšã‚‰ã™
          if(data[j].start >= tmp.start){
            data[j + 1] = data[j]
          } else {
            //å°ã•ããªã‘ã‚Œã°ã€ãšã‚‰ã™å‡¦ç†ã‚’æ­¢ã‚ã‚‹
            break;
          }
        }
        //ãšã‚‰ã™å‡¦ç†ãŒçµ‚ã‚ã£ãŸã¨ã“ã‚ã«ã€ŒæŒ¿å…¥ã™ã‚‹å€¤ã€ã‚’å…¥ã‚Œã‚‹
        data[j + 1] = tmp;
      }
    
      for (var i = 1; i < data.length; i++) {
        //ã€ŒæŒ¿å…¥ã™ã‚‹å€¤ã€ã‚’å¤‰æ•°ã«ä¸€æ™‚ä¿å­˜ã™ã‚‹
        let tmp = data[i];
    
        //ã€Œæ•´åˆ—æ¸ˆã¿ã®éƒ¨åˆ†ã€ã®ã©ã“ã«æŒ¿å…¥ã™ã‚Œã°è‰¯ã„ã‹å¾Œã‚ã‹ã‚‰å‰ã«å‘ã‹ã£ã¦é †ç•ªã«åˆ¤æ–­ã™ã‚‹
        for (var j = i - 1; j >= 0; j--) {
          //ã€ŒæŒ¿å…¥ã™ã‚‹å€¤ã€ãŒå¤§ãã„å ´åˆã€èª¿ã¹ãŸå€¤ã‚’ï¼‘ã¤å¾Œã‚ã¸ãšã‚‰ã™
          if(data[j].start === tmp.start && data[j].end <= tmp.end){
            data[j + 1] = data[j]
          } else {
            //å°ã•ããªã‘ã‚Œã°ã€ãšã‚‰ã™å‡¦ç†ã‚’æ­¢ã‚ã‚‹
            break;
          }
        }
        //ãšã‚‰ã™å‡¦ç†ãŒçµ‚ã‚ã£ãŸã¨ã“ã‚ã«ã€ŒæŒ¿å…¥ã™ã‚‹å€¤ã€ã‚’å…¥ã‚Œã‚‹
        data[j + 1] = tmp;
      }
      return data
    }
  </script>
</body>

</html>
